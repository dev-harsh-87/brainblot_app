rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper functions
    function isAuthenticated() {
      return request.auth != null;
    }
    
    function isOwner(userId) {
      return request.auth.uid == userId;
    }
    
    function getUserData() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data;
    }
    
    function isAdmin() {
      return isAuthenticated() &&
             exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
             (getUserData().role == 'admin' || getUserData().is_admin == true);
    }
    
    function isCoach() {
      return isAuthenticated() &&
             exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
             getUserData().role == 'coach';
    }
    
    function hasModuleAccess(module) {
      return isAuthenticated() &&
             exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
             'subscription' in getUserData() &&
             'moduleAccess' in getUserData().subscription &&
             module in getUserData().subscription.moduleAccess &&
             getUserData().subscription.moduleAccess[module] == true;
    }
    
    function isActiveUser() {
      return isAuthenticated() && (
        !exists(/databases/$(database)/documents/users/$(request.auth.uid)) ||
        !('status' in getUserData()) ||
        getUserData().status == 'active'
      );
    }
    
    // Users collection
    match /users/{userId} {
      // Allow unauthenticated read to check if admin exists during app startup
      allow read: if (!isAuthenticated() && resource.data.role == 'admin') ||
                    (isAuthenticated() && (
                      isOwner(userId) ||
                      isAdmin() ||
                      (isCoach() && hasModuleAccess('user_management'))
                    ));
      
      // Allow unauthenticated list queries to find admin users during startup
      allow list: if !isAuthenticated();
      
      // Allow unauthenticated user creation for admin setup
      // Allow authenticated admins to create users for other people
      allow create: if (isAuthenticated() && isOwner(userId)) ||
                      (!isAuthenticated() && resource.data.role == 'admin') ||
                      (isAuthenticated() && isAdmin());
      
      allow update: if isAuthenticated() && (
        isOwner(userId) ||
        isAdmin() ||
        (isCoach() && hasModuleAccess('user_management'))
      );
      
      allow delete: if isAdmin();
    }
    
    // Drills collection
    match /drills/{drillId} {
      allow read, list: if isAuthenticated() && (
        // Admin can see all drills
        isAdmin() ||
        // Own drills
        resource.data.createdBy == request.auth.uid ||
        // Public drills
        resource.data.visibility == 'public' ||
        // Shared drills
        request.auth.uid in resource.data.sharedWith ||
        // Allow basic access for active users
        isActiveUser()
      );
      
      allow create: if isAuthenticated() && (
        // Own drills
        (request.auth.uid == resource.data.createdBy &&
         resource.data.status == 'active') ||
        // Admin can create any drill
        isAdmin()
      );
      
      allow update: if isAuthenticated() && (
        // Own drills
        resource.data.createdBy == request.auth.uid ||
        // Admin can edit all
        isAdmin()
      );
      
      allow delete: if isAuthenticated() && (
        resource.data.createdBy == request.auth.uid ||
        isAdmin()
      );
    }
    
    // Programs collection
    match /programs/{programId} {
      allow read, list: if isAuthenticated() && (
        // Own programs
        resource.data.createdBy == request.auth.uid ||
        // Public programs
        resource.data.visibility == 'public' ||
        // Shared programs
        request.auth.uid in resource.data.sharedWith ||
        // Admin can see all
        isAdmin() ||
        // Users with admin_programs access can see admin programs
        (hasModuleAccess('admin_programs') &&
         ('createdByRole' in resource.data && resource.data.createdByRole == 'admin')) ||
        // Users with admin_programs access can see programs marked as admin
        (hasModuleAccess('admin_programs') &&
         ('is_admin' in resource.data && resource.data.is_admin == true)) ||
        // Allow basic access for active users
        isActiveUser()
      );
      
      allow create: if isAuthenticated() && (
        (request.auth.uid == request.resource.data.createdBy &&
         request.resource.data.status == 'active') ||
        // Admin can create any program
        isAdmin() ||
        // Users with admin_programs access can create admin programs
        (hasModuleAccess('admin_programs') &&
         request.resource.data.is_admin == true)
      );
      
      allow update: if isAuthenticated() && (
        resource.data.createdBy == request.auth.uid ||
        isAdmin() ||
        // Users with admin_programs access can update admin programs
        (hasModuleAccess('admin_programs') &&
         ('is_admin' in resource.data && resource.data.is_admin == true))
      );
      
      allow delete: if isAuthenticated() && (
        resource.data.createdBy == request.auth.uid ||
        isAdmin() ||
        // Users with admin_programs access can delete admin programs
        (hasModuleAccess('admin_programs') &&
         ('is_admin' in resource.data && resource.data.is_admin == true))
      );
    }
    
    // User activities collection
    match /user_activities/{activityId} {
      allow read, list: if isAuthenticated() && (
        resource.data.userId == request.auth.uid ||
        isAdmin() ||
        (isCoach() && hasModuleAccess('analytics'))
      );
      
      allow create: if isAuthenticated() &&
                      request.auth.uid == resource.data.userId;
      
      allow update: if isAuthenticated() &&
                      resource.data.userId == request.auth.uid;
      
      allow delete: if isAuthenticated() && (
        resource.data.userId == request.auth.uid ||
        isAdmin()
      );
    }
    
    // User favorites collection
    match /user_favorites/{favoriteId} {
      allow read, list: if isAuthenticated() && (
        resource.data.userId == request.auth.uid ||
        isAdmin()
      );
      
      allow create: if isAuthenticated() &&
                      request.auth.uid == request.resource.data.userId;
      
      allow update: if isAuthenticated() && (
        resource.data.userId == request.auth.uid ||
        isAdmin()
      );
      
      allow delete: if isAuthenticated() && (
        resource.data.userId == request.auth.uid ||
        isAdmin()
      );
    }
    
    // Categories collection (read-only for most users)
    match /categories/{categoryId} {
      allow read, list: if isAuthenticated();
      
      allow write: if isAdmin();
    }
    
    // Drill categories collection
    match /drill_categories/{categoryId} {
      // Allow authenticated users to read categories
      allow read, list: if isAuthenticated();
      
      // Allow admins to perform all operations
      allow write: if isAdmin();
    }
    
    // Subscription plans collection (read-only for most users)
    match /subscription_plans/{planId} {
      // Allow unauthenticated read for initial app setup
      allow read: if true;
      
      // Allow unauthenticated write for initial app setup (admin creation)
      allow write: if isAdmin() || !isAuthenticated();
    }
    
    // Sessions collection
    match /sessions/{sessionId} {
      allow read, list: if isAuthenticated() && (
        resource.data.userId == request.auth.uid ||
        isAdmin()
      );
      
      allow create: if isAuthenticated() &&
                      request.auth.uid == resource.data.userId;
      
      allow update: if isAuthenticated() &&
                      resource.data.userId == request.auth.uid;
      
      allow delete: if isAuthenticated() && (
        resource.data.userId == request.auth.uid ||
        isAdmin()
      );
    }
    
    // Device sessions collection
    match /deviceSessions/{sessionId} {
      allow read, list: if isAuthenticated() && (
        resource.data.userId == request.auth.uid ||
        isAdmin()
      );
      
      allow write: if isAuthenticated() && (
        resource.data.userId == request.auth.uid ||
        isAdmin()
      );
    }
    
    // User sessions collection
    match /userSessions/{userId} {
      allow read, list: if isAuthenticated() && (
        isOwner(userId) ||
        isAdmin()
      );
      
      allow write: if isAuthenticated() && (
        isOwner(userId) ||
        isAdmin()
      );
      
      // Nested sessions subcollection
      match /sessions/{sessionId} {
        allow read, list: if isAuthenticated() && (
          isOwner(userId) ||
          isAdmin()
        );
        
        allow write: if isAuthenticated() && (
          isOwner(userId) ||
          isAdmin()
        );
      }
    }
    
    // User sessions collection (with underscore - for session repository)
    match /user_sessions/{userId} {
      allow read, list: if isAuthenticated() && (
        isOwner(userId) ||
        isAdmin()
      );
      
      allow write: if isAuthenticated() && (
        isOwner(userId) ||
        isAdmin()
      );
      
      // Nested sessions subcollection
      match /sessions/{sessionId} {
        allow read, list: if isAuthenticated() && (
          isOwner(userId) ||
          isAdmin()
        );
        
        allow write: if isAuthenticated() && (
          isOwner(userId) ||
          isAdmin()
        );
      }
    }
    
    // Logout notifications collection
    match /logoutNotifications/{notificationId} {
      allow read, list: if isAuthenticated() && (
        resource.data.userId == request.auth.uid ||
        isAdmin()
      );
      
      allow write: if isAuthenticated() && (
        resource.data.userId == request.auth.uid ||
        isAdmin()
      );
    }
    
    // Active programs collection
    match /active_programs/{userId} {
      allow read, list: if isAuthenticated() && (
        isOwner(userId) ||
        isAdmin()
      );
      
      allow write: if isAuthenticated() && (
        isOwner(userId) ||
        isAdmin()
      );
    }
    
    // Program progress collection
    match /program_progress/{progressId} {
      allow read, list: if isAuthenticated() && (
        resource.data.userId == request.auth.uid ||
        isAdmin()
      );
      
      allow write: if isAuthenticated() && (
        resource.data.userId == request.auth.uid ||
        isAdmin()
      );
      
      // Nested completions subcollection
      match /completions/{completionId} {
        allow read, list: if isAuthenticated() && (
          resource.data.userId == request.auth.uid ||
          isAdmin()
        );
        
        allow write: if isAuthenticated() && (
          resource.data.userId == request.auth.uid ||
          isAdmin()
        );
      }
    }
    
    // User programs collection (nested under users)
    match /user_programs/{userId} {
      allow read, list: if isAuthenticated() && (
        isOwner(userId) ||
        isAdmin()
      );
      
      allow write: if isAuthenticated() && (
        isOwner(userId) ||
        isAdmin()
      );
      
      // Nested programs subcollection
      match /programs/{programId} {
        allow read, list: if isAuthenticated() && (
          isOwner(userId) ||
          isAdmin()
        );
        
        allow write: if isAuthenticated() && (
          isOwner(userId) ||
          isAdmin()
        );
      }
    }
    
    // User drills collection (nested under users)
    match /users/{userId}/drills/{drillId} {
      allow read, list: if isAuthenticated() && (
        isOwner(userId) ||
        isAdmin()
      );
      
      allow write: if isAuthenticated() && (
        isOwner(userId) ||
        isAdmin()
      );
    }
    
    // User programs collection (nested under users)
    match /users/{userId}/programs/{programId} {
      allow read, list: if isAuthenticated() && (
        isOwner(userId) ||
        isAdmin()
      );
      
      allow write: if isAuthenticated() && (
        isOwner(userId) ||
        isAdmin()
      );
    }
    
    // User sessions collection (nested under users)
    match /users/{userId}/sessions/{sessionId} {
      allow read, list: if isAuthenticated() && (
        isOwner(userId) ||
        isAdmin()
      );
      
      allow write: if isAuthenticated() && (
        isOwner(userId) ||
        isAdmin()
      );
    }
    
    // Invitations collection
    match /invitations/{invitationId} {
      allow read, list: if isAuthenticated() && (
        resource.data.fromUserId == request.auth.uid ||
        resource.data.toUserId == request.auth.uid ||
        isAdmin()
      );
      
      allow create: if isAuthenticated() &&
                      request.auth.uid == resource.data.fromUserId;
      
      allow update: if isAuthenticated() && (
        resource.data.fromUserId == request.auth.uid ||
        resource.data.toUserId == request.auth.uid ||
        isAdmin()
      );
      
      allow delete: if isAuthenticated() && (
        resource.data.fromUserId == request.auth.uid ||
        isAdmin()
      );
    }
    
    // Subscription requests collection
    match /subscription_requests/{requestId} {
      allow read, list: if isAuthenticated() && (
        resource.data.userId == request.auth.uid ||
        isAdmin()
      );
      
      allow create: if isAuthenticated() &&
                      request.auth.uid == resource.data.userId;
      
      allow update: if isAdmin();
      
      allow delete: if isAdmin();
    }
    
    // Notifications collection
    match /notifications/{notificationId} {
      allow read, list: if isAuthenticated() && (
        resource.data.userId == request.auth.uid ||
        isAdmin()
      );
      
      allow create: if isAuthenticated();
      
      allow update: if isAuthenticated() && (
        resource.data.userId == request.auth.uid ||
        isAdmin()
      );
      
      allow delete: if isAuthenticated() && (
        resource.data.userId == request.auth.uid ||
        isAdmin()
      );
    }
    
    // Analytics collection
    match /analytics/{analyticsId} {
      allow read, list: if isAdmin();
      
      allow create: if isAuthenticated();
      
      allow update: if isAdmin();
      
      allow delete: if isAdmin();
    }
    
    // System collection
    match /system/{systemId} {
      allow read: if isAuthenticated();
      
      allow write: if isAdmin();
      
      // Nested errors subcollection
      match /errors/{errorId} {
        allow read, list: if isAdmin();
        
        allow write: if isAdmin();
      }
    }
    
    // Deleted users collection
    match /deleted_users/{userId} {
      allow read, list: if isAdmin();
      
      allow write: if isAdmin();
    }
    
    // Pending auth users collection
    match /pending_auth_users/{userId} {
      allow read, list: if isAdmin();
      
      allow write: if isAdmin();
    }
    
    // User audit log collection
    match /user_audit_log/{logId} {
      allow read, list: if isAdmin();
      
      allow create: if isAuthenticated();
      
      allow update: if isAdmin();
      
      allow delete: if isAdmin();
    }
    
    // Plan requests collection
    match /plan_requests/{requestId} {
      allow read, list: if isAuthenticated() && (
        resource.data.userId == request.auth.uid ||
        isAdmin()
      );
      
      allow create: if isAuthenticated() &&
                      request.auth.uid == resource.data.userId;
      
      allow update: if isAdmin();
      
      allow delete: if isAdmin();
    }
  }
}